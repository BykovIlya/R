---
title: "Econometrics_lab"
author: "Ляпина Екатерина и Гайдаржи Дмитрий"
date: "Tuesday, April 21, 2015"
output: html_document
---

**Состав команды:**

Ляпина Екатерина, Дмитрий Гайдаржи

Для анализа были взяты следующие данные, предоставленные преподавателем в рамках курса эконометрики в ВШЭ. Загружаем необходимые для исследования пакеты и данные из файла.


```{r,fig.align='center'}
# Esli russkie bukvi prevratilitis v krakozyabry,
# to File - Reopen with encoding... - UTF-8 - Set as default - OK


#install.packages("foreign")
library("foreign") # конвертация файлов Stata
#install.packages("dplyr")
library("dplyr") # манипуляции с данными
#install.packages("erer")
library("erer") # расчет предельных эффектов
#install.packages("vcd")
library("vcd") # графики для качественных данных
#install.packages("ggplot2")
library("ggplot2") # графики
#install.packages("reshape2")
library("reshape2") # манипуляции с данными
#install.packages("AUC")
library("AUC") # для ROC кривой


# читаем данные
women <- read.dta("womenwk_data.dta")
```

**Объектом исследования** является занятость слабого пола.

**Предметом исследования** выступают причинно-следственные связи и зависимости экономических и социальных показателей, сформированных в результате деятельсноти женщины.

**Цель работы:** 

Выяснить, какие факторы могут влиять на выбор женщины работать – не работать.


**Задачи:**

Прохождение этапов извлечения, очистки и трансформации сырых данных.
Использование разных методик и средств математической статистики для построения модели. Практическая задача сводится к необходимости выявления, в какой степени какие факторы определяют занятость женщин и почему.


#Описание данных:

В нашем наборе данных `r nrow(women)` наблюдений и `r ncol(women)` переменных. Исходный файл с данными в формате dat (формат Stata).


###Описание исходных переменных:

- **age**: возраст, в годах.
- **education** : число полных лет обучения, в годах.
- **married** : состояние в браке (1 – если состоит, 0 – иначе).
- **children** : наличие детей (порядковая переменная, принимает значения от 0 до 5).
- **wagefull** : годовой доход женщины, тыс. долл.
- **wage** : годовой доход работающей женщины, тыс. долл.

Сначала необходимо сгенерировать зависимую переменную work. Она принимает значение 1, если женщина работает, и 0 – если не работает. Для создания этой переменной выполняем следующие действия: 

```{r}
# при загрузке файлов R автоматом переделывает все строковые переменные в факторные, просим R так не делать
options(stringsAsFactors=FALSE)

#создаем переменную work
for (i in 1:nrow(women)) women[i,7]  = ifelse(women[i,5]==women[i,6], 1, 0)
for (i in 1:nrow(women)) women[i,7]  = ifelse(is.na(women[i,7]), 0, 1)
names(women) <- c("age","education","married", "children","wagefull","wage", "work")

# объясняем R, какие переменные считать факторными
women <- mutate(women,married=as.factor(married),work=as.factor(work))
```

Рассчитаем описательные характеристики: 
```{r, results='asis'}
knitr::kable(summary(women))
```

Также построим пару графиков, для того, чтобы лучше понимать, с чем мы имеем дело: мозаичный график, график-вилончель, "ящик с усами" и 2 варианты сглаженной функции плотности для зависимости занятости от возраста и образования.

```{r}
# мозаичный график
mosaic(data=women,~married+children+work,shade=TRUE)

# график-виолончель
qplot(data=women,x=work,y=age,geom="violin")

# и "ящик с усами"
qplot(data=women,x=work,y=age,geom="boxplot")

#сглаженная функция плотности от возраста
qplot(data=women,x=age,y=..count..,fill=work,geom="density",position="stack")
#сглаженная функция плотности от щбразования
qplot(data=women,x=education,y=..count..,fill=work,geom="density",position="fill")
```


Проведем построения логит и пробит модели исходных данных:

```{r}
# Построение логит и пробит моделей
m_logit <- glm(data=women, work~age + education + married + children,
               family=binomial(link="logit"),x=TRUE)
m_probit <- glm(data=women, work~age + education + married + children,
                family=binomial(link="probit"),x=TRUE)
```


Рассчитаем характеристики логит модели: 
```{r}
summary(m_logit)
```

Рассчитаем характеристики пробит модели: 
```{r}
summary(m_probit)
```

Все переменные в моделях значимы. В силу масштабирования скрытой переменной коэффициенты в логит модели отличаются от коэффициентов  в пробит модели примерно в 1.6 раза. AIC моеделй одинаков - 2070.4. Мы можем построить ковариационную матрицу оцененных коэффициентов для логит модели:
```{r, results='asis'}
knitr::kable(vcov(m_logit))
```

Дальше мы хотим узнать, на сколько увеличивается вероятность пойти работать, при росте той или иной переменной на 1. Найдем предельные эффекты для средней по всем показателям женщины:
```{r}
maBina(m_logit) # предельные эффекты
```

К примеру, увеличение возраста на 1 год увеличивает вероятность пойти работать на 0.012. Если мы хотим усредненнить эффект по всем женщинам:
```{r}
maBina(m_logit,x.mean = FALSE)
```

Например, увеличение возраста на 1 год для каждой женщины увеличит ее вероятность пойти работать на 0.010. Дальше мы хотим узнать, какова вероятность того, что женщина, не имеющая детей, будет работать:
```{r}
# создаём новый массив данных для оценки
newdata_women <- data.frame(women$age, women$education,  women$married,	women$children=="0")
names(newdata_women) <- c("age","education","married","children")
newdata_women$children <- 0

# прогнозируем по логит модели 
pr_logit <- predict(m_logit,newdata_women,se=TRUE)
# соединим прогнозы и новый массив данных в единую табличку:
newdata_pr <- cbind(newdata_women,pr_logit)
head(newdata_pr) # глянем на начало таблички

# применив логистическую функцию распределения получим границы доверительного интервала
newdata_pr <- mutate(newdata_pr,prob=plogis(fit),
                     left_ci=plogis(fit-1.96*se.fit),
                     right_ci=plogis(fit+1.96*se.fit))

# посмотрим на графике как меняется доверительный интервал для вероятности
qplot(data=newdata_pr,x=age,y=prob,geom="line") +
  geom_ribbon(aes(ymin=left_ci,ymax=right_ci),alpha=0.2)
```

Построим обычную линейную регерссию методом МНК:
```{r}
# обычный МНК
m_ols <- lm(data=women, as.numeric(work)~age + education + married + children)
summary(m_ols)

# прогнозы по обычному МНК
pr_ols <- predict(m_ols,newdata_women)
head(pr_ols)
```

мы уже видим, что веростность не лежат в промежутке от 0 до 1. Поэтому мы используем логит и пробит модели. Однако, нам дали вероятность в промежутке, а не 0 или 1. Там нужно точное значение, попытаемся выбрать порог прогнозирования с помошью ROC-кривой. 
```{r}
# ROC кривая
# спрогнозируем скрытую переменную для исходного набора данных
pr_t <- predict(m_logit,women,se=TRUE)
# соединим прогнозы с исходным набором данных
women <- cbind(women,pr_t)
# применим логистическую функцию распределения, чтобы получить вероятности
women <- mutate(women,prob=plogis(fit))


# получим все данные для ROC кривой:
roc.data <- roc(women$prob,women$work)
str(roc.data)

# три графика для выбора порога отсечения
# по горизонтали --- пороги, по вертикали --- чувствительность 
# чувствительность = число верно предсказанных значений / общее количество женщин
qplot(x=roc.data$cutoffs,y=roc.data$tpr,geom="line", xlab = "Порог отсечения", ylab = 'Доля верно классифицированных работающих женщин')

# по горизонтали --- пороги, по вертикали --- процент ложноположительных прогнозов
# процент ложно положительных прогнозов =
# число не работающих ошибочно предсказанных работающих/общее число женщин
qplot(x=roc.data$cutoffs,y=roc.data$fpr,geom="line", xlab = "Порог отсечения", ylab = 'Доля не верно классифицированных не работающих женщин')

# по горизонтали --- процент ложноположительных прогнозов
# по вертикали --- чувствительность
qplot(x=roc.data$fpr,y=roc.data$tpr,geom="line", xlab = "Доля верно классифицированных работающих женщин", ylab = 'Доля не верно классифицированных не работающих женщин', main='ROC кривая')
```

Увеличения уровня отсечения, как правило, приводит к тому, что доля верно классифицированных работающих женщин и доля неверно классифицированных неработающих женщин падает.


