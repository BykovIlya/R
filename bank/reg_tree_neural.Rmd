---
title: "Исследование банкротства фирм."
lang: russian
---
#Состав команды:

Ляпина Екатерина, Дмитрий Гайдаржи

Для анализа были взяты следующие данные: 
https://drive.google.com/file/d/0Bw_qUDxhcJMjdXNpTDhPb3R0alU/view?usp=sharing


#Описание предметной области:

Набор данных содержит показатели финансового состояния предприятия и индикатор его способности расплатиться по долгам (банкротство) за итоговый период аудита.


```{r}
<img src='Porco-cofre.jpg' />
```


#Цель работы: 

Установление структурных связей и закономерностей между элементами исследуемой системы в выбранной предметной области. Последующая интерпретация имеющихся данных, анализ применимости полученных результатов и создание наилучшей модели для дальнейшего прогнозирования подобных данных. В практическом смысле, аналитические модели могут успешно использоваться для решения задач выявления банкротства фирмы, и предупреждения подобных ситуаций.


#Задачи:

Прохождение этапов извлечения, очистки и трансформации сырых данных.
Использование разных методик и средств для машинного обучения:
— классификации;
— дерева решений;
— кластеризации;
— нейронных сетей;

Необходимо выяснить, в какой степени какие факторы определяют состоятельность компании и почему.


#Описание данных:

В нашем наборе данных `r nrow(bankruptcy)` наблюдений и 7 переменных. Исходный файл с данными в формате xlxs.


#Описание исходных переменных:

- **ID**: индекс записи, ее номер (в дальнейшем используется для выделения рандомных проверочных данных).
- **Ликвидность.активов** : экономический термин, обозначающий способность активов быть быстро проданными по цене, близкой к рыночной. Показатель изменяется от 0 до 1.
- **Рентабельность.активов** : показатель, который характеризует способность руководства компании эффективно использовать ее активы для получения прибыли. Этот коэффициент отражает среднюю доходность, полученную на все источники капитала (собственного и заемного), рассчитывается по формуле: рентабельность активов = чистая прибыль / активы
- **Доходность.активов** : чистая прибыль в процентном отношении к активам.
- **Автономность** : коэффициент финансовой независимости, характеризует отношение собственного капитала к общей сумме капитала организации. Коэффициент показывает, насколько организация независима от кредиторов. Чем меньше значение коэффициента, тем в большей степени организация зависима от заемных источников финансирование, тем менее устойчивое у нее финансовое положение.
- **Оборачиваемость.активов** : финансовый показатель интенсивности использования организацией всей совокупности имеющихся активов. Данный показатель используется наряду с другими показателями для анализа эффективности управления имуществом и обязательствами фирмы.
- **Банкрот** (зависимая переменная) : бинарная переменная (1 - да, 0 - нет), обозначает неспособность должника в полном объеме удовлетворить требования кредиторов по денежным обязательствам и (или) исполнить обязанность по уплате обязательных платежей.


```{r, include=FALSE}
Sys.setenv(LANG = "en")
library(ggplot2)
library("MASS")
library("epicalc")
library("outliers")
library("rpart")
library("randomForest")
library("C50")
library("neuralnet")
library("knitr")
library("pander")

#считываем данные из файла
bankruptcy <- read.csv(file="Предприятия-А.csv",stringsAsFactors = FALSE, header=TRUE, sep=";", dec= ".")
for (i in 2:7) bankruptcy[,i]  <- as.numeric(as.character(bankruptcy[,i]))
opts_chunk$set(echo=FALSE, message=FALSE)
```


Описательная статистика по нашей выбоке:
```{r, results='asis'}
pander(summary(bankruptcy))
```
Диаграммы рассеивания для имеющихся переменных:
```{r}
pairs(Банкрот ~ Ликвидность.активов + Рентабельность.активов  + Доходность.активов	+ Автономность +	Оборачиваемость.активов,data = bankruptcy, main = "Диаграммы рассеивания для всех переменных")
```


Мы решили исключить выбросы из наших данных. После преобразований диаграммы Бокса-Вискера стали такими:

```{r, include=FALSE}
bankruptcy <- bankruptcy[ which(bankruptcy$Автономность < 30 ), ]
bankruptcy <- bankruptcy[ which(bankruptcy$Рентабельность.активов > -6), ]
bankruptcy <- bankruptcy[ which(bankruptcy$Доходность.активов > -6), ]
bankruptcy <- bankruptcy[ which(bankruptcy$Оборачиваемость.активов < 10), ]
bankruptcy <- bankruptcy[ which(bankruptcy$Доходность.активов > -6), ]
```


Построим диаграмму Бокса-Вискера для зависимости банкротсва от ликвидности активов фирмы.

```{r}
boxplot(Ликвидность.активов ~ Банкрот , data = bankruptcy, xlab = "Ликвидность активов", ylab = "Банкрот", main = "Зависимость банкротства от ликвидности активов")
```


Построим диаграмму Бокса-Вискера для зависимости банкротства от рентабельности активов.

```{r}
boxplot(Рентабельность.активов ~ Банкрот , data = bankruptcy, xlab = "Рентабельность активов", ylab = "Банкрот", main = "Зависимость банкротства от рентабельности активов")
```


Построим диаграмму Бокса-Вискера для зависимость банкротства от доходности активов.

```{r}
boxplot(Доходность.активов ~ Банкрот , data = bankruptcy, xlab = "Доходность активов", ylab = "Банкрот", main = "Зависимость банкротства от доходности активов")
```


Построим диаграмму Бокса-Вискера для зависимости банкротства от автономности активов.

```{r}
boxplot(Автономность ~ Банкрот , data = bankruptcy, xlab = "Автономность", ylab = "Банкрот", main = "Зависимость банкротства от автономности активов")
```


Построим диаграмму Бокса-Вискера для зависимости банкротства от оборачиваемости активов.

```{r}
boxplot(Оборачиваемость.активов ~ Банкрот , data = bankruptcy, xlab = "Оборачиваемость.активов", ylab = "Банкрот", main = "Зависимость банкротства от оборачиваемости активов")
```


Для проверки полученной модели мы разделили все имеющиеся данные в соотношении 85:15. То есть тренировочными данными мы сделали 211 запись, мы выбрали их случайным образом из нашей выборки так, чтобы подвыборка была репрезентативная нашим данным.

```{r, results='asis'}
ind1 <- subset(bankruptcy, bankruptcy[,"Банкрот"]==1, select=ID: Банкрот)
ind0 <- subset(bankruptcy, bankruptcy[,"Банкрот"]==0, select=ID: Банкрот)
sampind1 <- ind1[sample(1:nrow(ind1), 53, replace=FALSE),]
sampind0 <- ind0[sample(1:nrow(ind0), 158, replace=FALSE),]

training_data <- rbind(sampind0, sampind1)
testing_data <- bankruptcy[!(bankruptcy$ID %in% training_data$ID),]
rownames(training_data)<-NULL
rownames(testing_data)<-NULL
rm(ind0, ind1, sampind0, sampind1, i)
clear_test <- subset(testing_data, select=Ликвидность.активов:Банкрот)
```

Построение моделей мы начали с логистической регрессии. В процессе исследования оказалось, что Оборачиваемость активов и Автономность мало влияют на Банкротство, эти переменные были исключены из итоговой модели. Полученная регрессия также применялась для прогнозирования.
```{r, results='asis'}
glm.out <- step(glm(Банкрот ~ Ликвидность.активов + Рентабельность.активов + Доходность.активов + Оборачиваемость.активов, family=binomial, data=training_data))
summary(glm.out)
exp(confint(glm.out))
#Округлим полученные значения
testing_data$predicted_value_log <-  predict(glm.out, newdata = clear_test, type = "response")
convert <- function(data){if(data >= 0.5)return (1) else return (0)}
testing_data$predicted_value_log <- lapply(testing_data$predicted_value_log, convert)

```

В последующем мы построили регрессионное деревое, воспользовавшись алгоритмом CART. Дерово было использовано для дальнейшего прогнозирования и сравнения моделей.

```{r, results='asis'}
#Строим регрессионное дерево
reg_tree <- rpart(Банкрот ~ Ликвидность.активов + Рентабельность.активов + Доходность.активов + Оборачиваемость.активов, data = training_data, method = "anova")
printcp(reg_tree)
plotcp(reg_tree) # покажем график кросс-валидации
summary(reg_tree) 

rsq.rpart(reg_tree) # visualize cross-validation results    
plot(reg_tree, uniform=TRUE, main="Дерево регрессии")
text(reg_tree, use.n=TRUE, all=TRUE, cex=.8)

#Тестим дерево
testing_data$predicted_value_regtree <- predict(reg_tree,  clear_test, type = c("vector", "prob", "class", "matrix"), na.action = na.pass)
correct <- function(data){if(data >= 0.5)return (1) else return (0)}
testing_data$predicted_value_regtree <- lapply(testing_data$predicted_value_regtree, correct)

```

Мы также воспользовались методом random forests для дальнейшего прогнозирования и сравнения моделей.
```{r, results='asis'}
#Метод random forests
fit <- randomForest(Банкрот ~ Ликвидность.активов + Рентабельность.активов + Доходность.активов + Оборачиваемость.активов, data=training_data)
print(fit) # view results 
importance(fit) # importance of each predictor

#Тестим дерево
testing_data$predicted_value_random <-predict(fit, clear_test, type="response" )
testing_data$predicted_value_random <- lapply(testing_data$predicted_value_random, correct)
plot(fit)
```


Последним регрессионным деревом стало дерево, построенное с использованием алгоритма C.5.0:

```{r, results='asis'}

```

