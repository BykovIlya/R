---
title: "RLMS"
author: "Ляпина Екатерина"
date: "Wednesday, April 15, 2015"
output: html_document
---
```{r, echo=FALSE, include=FALSE}
#devtools:: install_github("bdemeshev/rlms")
library("rlms") # загрузка данных в формате rlms (spss)
library(plyr)
library("knitr")
library("xtable")
library("ggplot2")
require(foreign)
require(MASS)

h_old <- read.rlms("r22i_os25a.sav")
```
```{r}
h <- subset(h_old, select=c(rj13.2 , rh6, r_int_y,  rh5, r_diplom, status, rj161.3y))
rm(h_old)
h <- na.omit(h)
h <- rename(h, c(rj13.2="payroll", rh6 = "birth", r_int_y = "age", rh5 = "sex", r_diplom = "education",  rj161.3y = "experience"))
h$age <- h$age - h$birth
h$birth <- NULL

saveRDS(h, file = "r22i_os25a.RDS") # сохраняем всё ценное в файл
h <- readRDS("r22i_os25a.RDS") # читаем из файла что там есть

for (i in 1:nrow(h)) h[i,7]  = ifelse((h[i,4]=="окончил 0 - 6 классов") || (h[i,5]=="незаконч среднее образование (7 - 8 кл)")|| (h[i,5]=="незаконч среднее образование (7 - 8 кл) + что-то еще"), 1, 0)
for (i in 1:nrow(h)) h[i,8]  = ifelse(h[i,4]=="законч среднее образование", 1, 0)
for (i in 1:nrow(h)) h[i,9]  = ifelse(h[i,4]=="законч среднее специальное образование", 1, 0)
for (i in 1:nrow(h)) h[i,10]  = ifelse(h[i,4]=="законч высшее образование и выше", 1, 0)
h <- rename(h, c(V7 ="ed_1", V8= "ed_2", V9 = "ed_3",  V10 = "ed_4"))

for (i in 1:nrow(h)) h[i,11]  = ifelse(h[i,5]=="областной центр ", 1, 0)
for (i in 1:nrow(h)) h[i,12]  = ifelse(h[i,5]=="город", 1, 0)
for (i in 1:nrow(h)) h[i,13]  = ifelse(h[i,5]=="ПГТ", 1, 0)
for (i in 1:nrow(h)) h[i,14]  = ifelse(h[i,5]=="село", 1, 0)
h <- rename(h, c(V11 = "st_1", V12 = "st_2", V13 = "st_3",  V14 = "st_4"))

for (i in 1:nrow(h)) h[i,15]  = ifelse(h[i,3]=="МУЖСКОЙ", 1, 0)
for (i in 1:nrow(h)) h[i,16]  = ifelse(h[i,3]=="ЖЕНСКИЙ", 1, 0)
h <- rename(h, c(V15 = "male", V16 = "female"))
h$status <- NULL
h$education <- NULL
h$sex <- NULL

```

**Объектом исследования** являются данные Российского мониторинга экономического положения и здоровья населения (РМЭЗ, он же RLMS), относящиеся к индивидам.


**Предметом исследования** выступают причинно-следственные связи и зависимости показателей.


**Цель работы:** 

Выявление факторов, влияющих на размер заработной платы. Установление структурных связей и закономерностей между элементами исследуемой системы в выбранной предметной области. Последующая интерпретация имеющихся данных, анализ применимости полученных результатов.


**Задачи:**

Прохождение этапов извлечения, очистки и трансформации сырых данных.
Практическая задача сводится к необходимости выявления, в какой степени какие факторы влияют на размер заработной платы и почему.


#Описание данных:

В нашем итоговом наборе данных `r nrow(h)` наблюдений. Исходный файл с данными в формате sav.


###Описание исходных переменных:

- **rj13.2**   : Заработная плата на основе опроса.
- **rh6**      : Год рождения респондента.
- **r_int_y**  : Год проведения опроса.
- **rh5**      : Пол (создано 2 фиктивные переменные).
- **r_diplom** : Образование (создано 4 фиктивные переменные).
- **status**   : Тип населенного пункта - размер населенного пункта может влиять положительно на средний уровень зарплат в нем (создано 4 фиктивные переменные).
- **rj161.3y** : Трудовой стаж в годах на момент опроса (стаж может влиять на заработную плату положительно).



После преобразования Стало 12 переменных: payroll, age, sex, experience, ed_1, ed_2, ed_3, ed_4, st_1, st_2, st_3, st_4

Описательная статистика по нашим переменным:
```{r, results='asis'}
knitr::kable(summary(h))
```

Стандартное отклонение по количественным переменным:
- **payroll**    : `r sd(h$payroll)`
- **age**        : `r sd(h$age)`
- **experience**: `r sd(h$experience)`


Построим гистограмму переменной payroll (доход):
```{r}
hist(h$payroll, right=FALSE, xlab="Зарплата", ylab="Частота", main="Гистограмма по зарплате")
```

Построим гистограмму переменной age (возраст):
```{r}
hist(h$age, right=FALSE, xlab="Возраст", ylab="Частота", main="Гистограмма по возрасту индивидов")
```



Построим простую линейную регрессию заработной платы на возраст (**age**), пол (по фиктивной перменной **male**), 3 фиктивные переменные на образование (за базовую категорию возьмем самый низкий уровень образования: **ed_2**, **ed_3**, **ed_4**), 3 фиктивные переменные на тип населенного пунта (за базовую возьмем первую переменную: **st_2**, **st_3**, **st_4**) и стаж работы (**experience**). Основные характеристики модели:

```{r}
model <- lm(payroll ~ age + male + ed_2 + ed_3 + ed_4 + st_2  + st_3  + st_4 + experience, data=h)
summary(model)
```

В нашем случае оказалось, что **все** переменные значимы на 5% уровне значимости, мы уверены в том, что свободные члены в нашем выражении отличны от нуля. Так как p-value намного меньше 0.05, мы отвергаем нулевую гипотезу о том, что коэффициенты ?? = 0. Следовательно, есть сильная связь между переменными в модели с нашей прогнозируемой переменной.
Вышло, что возраст отрицательно связан с размером заработной платы (возможно потому, что с возрастом человек менее трудоспособен).
В общем случае, образование положительно влияет на размер заработной платы, как и стаж работы, а проживание не в городе отрицательно влияет на уровень заработной платы, что также вполне объяснимо.




Построим простую линейную регрессию с робастными ошибками заработной платы на возраст (**age**), пол (по фиктивной перменной **male**), 3 фиктивные переменные на образование (за базовую категорию возьмем самый низкий уровень образования: **ed_2**, **ed_3**, **ed_4**), 3 фиктивные переменные на тип населенного пунта (за базовую возьмем первую переменную: **st_2**, **st_3**, **st_4**) и стаж работы (**experience**). Основные характеристики модели:

```{r}
model2 <- rlm(payroll ~ age + male + ed_2 + ed_3 + ed_4 + st_2  + st_3  + st_4 + experience, data=h) 
summary(model2)
```

В этой модели все переменные также остались значимыми на 5% уровне значимости. Знаки не изменились, коэффициенты немного скорректировались. Такая ситуация могла получиться из-за использования робастных ошибкок. Можно заметить, что с уменьшением значения разброса, значение веса для наблюдения увеличивается. Другими словами, наблюдения с большими по значению остатками, обозначаются как маловажные. Например, данный вывод показывает нам что наблюдением под номером 13281 будет меньше всех остальных принято во внимание. Если сравнивать робастную регрессию с обычной линейной, то в линейной регрессии все наблюдения учитываются с весом равном 1. Таким образом, чем больше наблюдений с весом равным 1 в робастной регрессии, тем больше она приближается к виду классической линейной регрессии.






